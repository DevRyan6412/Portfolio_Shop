<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>예약 관리</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f5f5f5;
    }

    .admin-container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background-color: #333;
      color: white;
      padding: 20px;
    }

    .sidebar h1 {
      font-size: 24px;
      margin-bottom: 30px;
      padding-bottom: 10px;
      border-bottom: 1px solid #555;
    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar li {
      margin-bottom: 10px;
    }

    .sidebar a {
      color: white;
      text-decoration: none;
      display: block;
      padding: 10px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .sidebar a:hover {
      background-color: #555;
    }

    .sidebar i {
      margin-right: 10px;
    }

    .main-content {
      flex: 1;
      padding: 20px;
    }

    .table-container {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-top: 20px;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
    }

    .admin-table th,
    .admin-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .admin-table th {
      background-color: #f8f9fa;
      font-weight: 600;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
      margin-right: 5px;
    }

    .btn-primary {
      background-color: #007bff;
      color: white;
    }

    .btn-danger {
      background-color: #dc3545;
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .form-control {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-confirmed {
      background-color: #d4edda;
      color: #155724;
    }

    .status-cancelled {
      background-color: #f8d7da;
      color: #721c24;
    }

    .filter-container {
      margin-bottom: 20px;
    }

    .filter-container select,
    .filter-container input {
      height: 35px;
    }
  </style>
</head>
<body>
<div class="admin-container">
  <div class="sidebar">
    <h1>관리자 페이지</h1>
    <ul>
      <li><a href="/admin/dashboard"><i class="fas fa-home"></i>대시보드</a></li>
      <li><a href="/admin/item/new"><i class="fa-solid fa-cash-register"></i>상품 등록 / 수정</a></li>
      <li><a href="/admin/items"><i class="fas fa-box"></i>상품 관리</a></li>
      <li><a href="/admin/orders"><i class="fas fa-shopping-cart"></i>주문 관리</a></li>
      <li><a href="/admin/members"><i class="fas fa-users"></i>회원 관리</a></li>
      <li><a href="/coupon/list"><i class="fas fa-ticket"></i>쿠폰 관리</a></li>
      <li><a href="/qna/admin"><i class="fas fa-question-circle"></i>문의 관리</a></li>
      <li><a href="/api/reservations"><i class="fas fa-calendar-alt"></i>예약 관리</a></li>
      <li><a href="/"><i class="fas fa-home"></i>홈으로</a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="table-container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>예약 관리</h2>
        <div class="filter-container">
          <input type="date" class="form-control" id="dateFilter">
          <select class="form-control" id="statusFilter">
            <option value="">전체 상태</option>
            <option value="PENDING">대기중</option>
            <option value="CONFIRMED">확정</option>
            <option value="CANCELLED">취소</option>
          </select>
          <input type="text" class="form-control" placeholder="예약자 검색...">
        </div>
      </div>

      <table class="admin-table">
        <thead>
        <tr>
          <th>예약번호</th>
          <th>예약자</th>
          <th>연락처</th>
          <th>예약일</th>
          <th>예약시간</th>
          <th>상태</th>
          <th>관리</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="reservation : ${reservations}">
          <td th:text="${reservation.id}"></td>
          <td th:text="${reservation.name}"></td>
          <td th:text="${reservation.phone}"></td>
          <td th:text="${#temporals.format(reservation.date, 'yyyy-MM-dd')}"></td>
          <td th:text="${reservation.time}"></td>
          <td>
                        <span th:class="${'status-badge ' +
                            (reservation.status.name() == 'PENDING' ? 'status-pending' :
                             reservation.status.name() == 'CONFIRMED' ? 'status-confirmed' :
                             'status-cancelled')}"
                              th:text="${reservation.status.getDisplayName()}">
                        </span>
          </td>
          <td>
            <button class="btn btn-primary"
                    th:if="${reservation.status.name() == 'PENDING'}"
                    th:onclick="|confirmReservation(${reservation.id})|">확정</button>
            <button class="btn btn-danger"
                    th:if="${reservation.status.name() != 'CANCELLED'}"
                    th:onclick="|cancelReservation(${reservation.id})|">취소</button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  function confirmReservation(id) {
    if (confirm('예약을 확정하시겠습니까?')) {
      updateReservationStatus(id, 'CONFIRMED');
    }
  }

  function cancelReservation(id) {
    if (confirm('예약을 취소하시겠습니까?')) {
      updateReservationStatus(id, 'CANCELLED');
    }
  }

  function updateReservationStatus(id, status) {
    fetch(`/api/reservations/${id}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(status)
    })
            .then(response => response.text())
            .then(result => {
              alert(result);
              location.reload();
            })
            .catch(error => {
              alert('오류가 발생했습니다.');
              console.error('Error:', error);
            });
  }

  // 필터링 기능
  function applyFilters() {
    const date = document.getElementById('dateFilter').value;
    const status = document.getElementById('statusFilter').value;
    const search = document.querySelector('input[type="text"]').value.toLowerCase();

    const rows = document.querySelectorAll('.admin-table tbody tr');

    rows.forEach(row => {
      const rowDate = row.children[3].textContent;
      const rowStatus = row.children[5].textContent;
      const rowText = row.textContent.toLowerCase();

      const dateMatch = !date || rowDate === date;
      const statusMatch = !status || rowStatus.includes(status);
      const searchMatch = !search || rowText.includes(search);

      row.style.display = dateMatch && statusMatch && searchMatch ? '' : 'none';
    });
  }

  document.getElementById('dateFilter').addEventListener('change', applyFilters);
  document.getElementById('statusFilter').addEventListener('change', applyFilters);
  document.querySelector('input[type="text"]').addEventListener('keyup', applyFilters);
</script>

</body>
</html>